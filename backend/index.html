<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Juego Three.js Protegido por JWT</title>
        <!-- Carga de Tailwind CSS para estilos modernos y responsivos -->
        <script src="https://cdn.tailwindcss.com"></script>
        <!-- Carga de Three.js -->
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
        <style>
        /* Estilos personalizados para el cuerpo y el canvas */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Fondo oscuro tipo GitHub */
            color: #c9d1d9;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            overflow: hidden; /* Evita barras de desplazamiento innecesarias */
        }
        #gameCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        /* Oculta los contenedores por defecto */
        .screen {
            display: none;
        }
    </style>
    </head>
    <body>

        <div id="appContainer" class="p-4 w-full max-w-2xl">
            <!-- Contenedor del Juego (THREE.JS) -->
            <div id="gameScreen"
                class="screen w-full h-[600px] bg-gray-900 shadow-2xl rounded-xl">
                <h1
                    class="text-3xl font-bold text-center pt-4 text-green-400">¡Juego
                    Iniciado!</h1>
                <p class="text-center mb-4 text-gray-400">Acceso concedido
                    mediante JWT. Mueve el mouse para orbitar.</p>
                <div id="gameCanvas"
                    class="w-full h-[500px] rounded-b-xl"></div>
            </div>

            <!-- Contenedor de Autenticación -->
            <div id="authScreen"
                class="screen bg-gray-800 p-8 rounded-xl shadow-2xl w-full">
                <h2 id="authTitle"
                    class="text-2xl font-semibold mb-6 text-center text-blue-400">Iniciar
                    Sesión</h2>

                <form id="authForm" class="space-y-4">
                    <div class="space-y-2">
                        <label for="username"
                            class="text-sm font-medium text-gray-400">Nombre de
                            Usuario</label>
                        <input type="text" id="username"
                            class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-blue-500 focus:border-blue-500"
                            placeholder="usuario_ejemplo" required>
                    </div>
                    <div class="space-y-2">
                        <label for="password"
                            class="text-sm font-medium text-gray-400">Contraseña</label>
                        <input type="password" id="password"
                            class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-blue-500 focus:border-blue-500"
                            placeholder="********" required>
                    </div>

                    <p id="message"
                        class="text-center text-sm font-medium h-5"></p>

                    <button type="submit" id="authButton"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition duration-200 shadow-md">
                        Acceder
                    </button>
                </form>

                <div class="mt-6 text-center">
                    <p class="text-sm text-gray-400">
                        <span id="toggleText">¿No tienes cuenta?</span>
                        <button id="toggleAuth"
                            class="text-blue-400 hover:text-blue-300 font-medium transition duration-200">
                            Regístrate
                        </button>
                    </p>
                </div>
            </div>
        </div>

        <script>
        // --- CONSTANTES Y ESTADO GLOBAL ---
        let JWT_TOKEN = localStorage.getItem('authToken');
        let IS_REGISTER_MODE = false;
        
        // Simulación de credenciales para el backend
        const MOCK_USERNAME = 'jugador';
        const MOCK_PASSWORD = 'password123';
        const MOCK_JWT = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjp7ImlkIjoiNjU3YzcyMTUzODdhZjM2YzEwZDMxYjU1In0sImlhdCI6MTcwMjY4Njc3OCwiZXhwIjoxNzAyNjg3Mzc4fQ.FAKE-TOKEN-FOR-DEMO-2023';

        // Elementos del DOM
        const authScreen = document.getElementById('authScreen');
        const gameScreen = document.getElementById('gameScreen');
        const authForm = document.getElementById('authForm');
        const authTitle = document.getElementById('authTitle');
        const authButton = document.getElementById('authButton');
        const toggleAuth = document.getElementById('toggleAuth');
        const toggleText = document.getElementById('toggleText');
        const message = document.getElementById('message');

        // --- FUNCIONES DE UTILIDAD ---

        /** Muestra la pantalla especificada y oculta las demás. */
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(el => el.style.display = 'none');
            document.getElementById(screenId).style.display = 'block';
        }

        /**
         * Lógica de retry con backoff para simular un fetch robusto.
         * En un entorno real, aquí se usaría la función fetch().
         */
        async function fakeFetchWithRetry(url, options, retries = 3) {
            message.textContent = 'Conectando al servidor...';
            message.className = 'text-center text-sm font-medium h-5 text-blue-400';
            
            await new Promise(resolve => setTimeout(resolve, 800)); // Simula latencia
            
            try {
                // Aquí iría el fetch real:
                // const response = await fetch(url, options);
                // const data = await response.json();
                
                // --- SIMULACIÓN DE RESPUESTA ---
                const { username, password } = JSON.parse(options.body);

                if (IS_REGISTER_MODE) {
                    // Simula registro exitoso
                    message.textContent = 'Registro exitoso. ¡Inicia sesión!';
                    message.className = 'text-center text-sm font-medium h-5 text-green-400';
                    setTimeout(() => {
                        // Cambia a login después del registro
                        IS_REGISTER_MODE = false;
                        updateAuthScreen();
                    }, 1500);
                    return { success: true, registered: true };

                } else if (username === MOCK_USERNAME && password === MOCK_PASSWORD) {
                    // Simula login exitoso y entrega del JWT
                    message.textContent = 'Inicio de sesión exitoso.';
                    message.className = 'text-center text-sm font-medium h-5 text-green-400';
                    return { success: true, token: MOCK_JWT };
                } else {
                    // Simula credenciales inválidas
                    message.textContent = 'Credenciales inválidas.';
                    message.className = 'text-center text-sm font-medium h-5 text-red-500';
                    return { success: false, status: 400 };
                }

            } catch (error) {
                if (retries > 0) {
                    console.warn(`Error de red simulado, reintentando... (${retries} restantes)`);
                    await new Promise(resolve => setTimeout(resolve, 1000 * (4 - retries)));
                    return fakeFetchWithRetry(url, options, retries - 1);
                }
                message.textContent = 'Error: No se pudo contactar al servidor.';
                message.className = 'text-center text-sm font-medium h-5 text-red-500';
                return { success: false, status: 500 };
            }
        }
        
        /**
         * Simula una llamada a una ruta protegida del backend.
         * Requiere que el JWT_TOKEN esté presente.
         */
        async function fetchProtectedData() {
            if (!JWT_TOKEN) {
                console.error("No hay token. Acceso denegado.");
                return;
            }

            console.log("Intentando acceder a ruta protegida con token...");
            
            // Simulación de la solicitud HTTP real al backend de Express
            const options = {
                method: 'GET',
                // IMPORTANTE: Aquí es donde se envía el token al middleware/auth.js
                headers: {
                    'Authorization': `Bearer ${JWT_TOKEN}`, 
                    'Content-Type': 'application/json'
                }
            };

            // En un entorno real se llamaría a /api/game/profile
            const response = await fakeFetchWithRetry('/api/game/profile', options, 0); 
            
            if (response.success) {
                console.log('Datos de perfil recibidos con éxito (ruta protegida):', response);
            } else {
                console.error('El servidor denegó el acceso (Token expirado/inválido).');
            }
        }


        // --- LÓGICA DE AUTENTICACIÓN ---

        function updateAuthScreen() {
            authTitle.textContent = IS_REGISTER_MODE ? 'Registro de Nuevo Usuario' : 'Iniciar Sesión';
            authButton.textContent = IS_REGISTER_MODE ? 'Registrarse' : 'Acceder';
            toggleText.textContent = IS_REGISTER_MODE ? '¿Ya tienes cuenta?' : '¿No tienes cuenta?';
            toggleAuth.textContent = IS_REGISTER_MODE ? 'Inicia Sesión' : 'Regístrate';
            message.textContent = ''; // Limpiar mensaje al cambiar modo
        }

        async function handleAuth(event) {
            event.preventDefault();
            message.textContent = '';

            const usernameInput = document.getElementById('username').value;
            const passwordInput = document.getElementById('password').value;

            if (!usernameInput || !passwordInput) {
                message.textContent = 'Por favor, introduce usuario y contraseña.';
                message.className = 'text-center text-sm font-medium h-5 text-red-500';
                return;
            }

            const url = IS_REGISTER_MODE ? '/api/auth/register' : '/api/auth/login';
            
            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: usernameInput, password: passwordInput })
            };

            const response = await fakeFetchWithRetry(url, options);

            if (response.success && response.token) {
                JWT_TOKEN = response.token;
                localStorage.setItem('authToken', JWT_TOKEN); // Guardar el token
                
                // Mostrar el juego después de un pequeño retraso
                setTimeout(() => {
                    initGame();
                    showScreen('gameScreen');
                }, 1000); 

                fetchProtectedData(); // Prueba de acceso a la ruta protegida
            }
        }

        // --- LÓGICA DE INICIALIZACIÓN DE THREE.JS ---

        let scene, camera, renderer, cube, controls;

        function initGame() {
            const container = document.getElementById('gameCanvas');
            const width = container.clientWidth;
            const height = container.clientHeight;

            // 1. Configuración de la Escena y Cámara
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x101319);
            
            camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
            camera.position.z = 5;

            // 2. Renderizador
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(width, height);
            container.appendChild(renderer.domElement);
            
            // Manejar redimensionamiento
            window.addEventListener('resize', onWindowResize, false);

            // 3. Objeto de Juego (Cubo)
            const geometry = new THREE.BoxGeometry(1, 1, 1);
            const material = new THREE.MeshLambertMaterial({ color: 0x4a90e2 }); // Material con luz
            cube = new THREE.Mesh(geometry, material);
            scene.add(cube);

            // 4. Luces
            const ambientLight = new THREE.AmbientLight(0x404040, 3); // Luz suave
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.5);
            directionalLight.position.set(0, 10, 5);
            scene.add(directionalLight);

            // 5. Controles de Orbit (simulado para Three.js, sin necesidad de librerías externas)
            let isDragging = false;
            let previousMousePosition = { x: 0, y: 0 };

            container.addEventListener('mousedown', (e) => {
                isDragging = true;
            });
            container.addEventListener('mouseup', (e) => {
                isDragging = false;
            });
            container.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const deltaX = e.offsetX - previousMousePosition.x;
                const deltaY = e.offsetY - previousMousePosition.y;

                // Rotar el cubo basado en el movimiento del ratón
                cube.rotation.y += deltaX * 0.005;
                cube.rotation.x += deltaY * 0.005;

                previousMousePosition = { x: e.offsetX, y: e.offsetY };
            });

            // 6. Loop de Animación
            animate();
        }

        function onWindowResize() {
            const container = document.getElementById('gameCanvas');
            if (container) {
                 camera.aspect = container.clientWidth / container.clientHeight;
                 camera.updateProjectionMatrix();
                 renderer.setSize(container.clientWidth, container.clientHeight);
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            // Animación continua de rotación
            cube.rotation.x += 0.005;
            cube.rotation.y += 0.01;
            renderer.render(scene, camera);
        }
        
        // --- INICIALIZACIÓN DEL CLIENTE ---
        document.addEventListener('DOMContentLoaded', () => {
            // Asignar manejadores de eventos
            authForm.addEventListener('submit', handleAuth);
            toggleAuth.addEventListener('click', () => {
                IS_REGISTER_MODE = !IS_REGISTER_MODE;
                updateAuthScreen();
            });

            // Comprobar si hay un token almacenado (simulando un "recuérdame")
            if (JWT_TOKEN) {
                // Si hay un token, asumimos que es válido y vamos directo al juego (en producción,
                // harías una llamada de verificación al backend primero).
                console.log("Token encontrado. Accediendo al juego...");
                initGame();
                showScreen('gameScreen');
            } else {
                // Si no hay token, mostrar la pantalla de autenticación
                updateAuthScreen();
                showScreen('authScreen');
            }
        });

        // --- Modo de Desarrollo / Desprotegido (Para Three.js que no esté atado al esquema seguro) ---
        // Si el token es nulo o la pantalla de autenticación está visible, la función initGame() no se ejecuta,
        // lo que cumple el requisito. Si deseas que el desarrollador pueda saltarse la autenticación
        // con un parámetro de URL, podrías añadir un chequeo como:
        // if (!JWT_TOKEN && window.location.search.includes('dev=true')) { initGame(); showScreen('gameScreen'); }
    </script>
    </body>
</html>